{% extends "base.html" %}

{% block title %}Inventory & Stock - Pharmacy KPI Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="kpi-card">
            <h2>Inventory Levels</h2>
            {% if inventory_levels %}
                <div class="table-responsive scrollable-table">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Product ID</th>
                                <th>Product Name</th>
                                <th>Initial Inventory</th>
                                <th>Quantity Sold (Total)</th>
                                <th>Current Inventory</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_levels %}
                                <tr>
                                    <td>{{ item.product_id }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.initial_inventory }}</td>
                                    <td>{{ item.quantity_sold_total }}</td>
                                    <td>{{ item.current_inventory }}</td>
                                    <td>{{ item.description }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <canvas id="inventoryLevelsChart"></canvas>
            {% else %}
                <p>No inventory level data available.</p>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="kpi-card">
            <h2>Stock-Out Events</h2>
            {% if stock_outs %}
                <div class="table-responsive scrollable-table">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product ID</th>
                                <th>Product Name</th>
                                <th>Quantity Sold During Stock-Out</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stock_outs %}
                                <tr>
                                    <td>{{ item.date }}</td>
                                    <td>{{ item.product_id }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.quantity_sold_during_stock_out }}</td>
                                    <td>{{ item.description }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No stock-out events recorded.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="kpi-card">
            <h2>Near Expiries (within 30 days)</h2>
            {% if near_expiries %}
                <div class="table-responsive scrollable-table">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Product ID</th>
                                <th>Product Name</th>
                                <th>Expiration Date</th>
                                <th>Days to Expiry</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in near_expiries %}
                                <tr>
                                    <td>{{ item.product_id }}</td>
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.expiration_date }}</td>
                                    <td>{{ item.days_to_expiry }}</td>
                                    <td>{{ item.description }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <canvas id="nearExpiriesChart"></canvas>
            {% else %}
                <p>No products near expiry.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Data for Inventory Levels Chart
    const inventoryLevelsData = {{ inventory_levels | tojson }};

    if (inventoryLevelsData && inventoryLevelsData.length > 0) {
        const labels = inventoryLevelsData.map(item => item.product_name);
        const data = inventoryLevelsData.map(item => item.current_inventory);

        const ctx = document.getElementById('inventoryLevelsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Current Inventory',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)', /* Muted teal */
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    borderRadius: 5 /* Rounded bars */
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, /* Allow custom height */
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Current Inventory',
                            color: '#343a40'
                        },
                        grid: {
                            color: '#e9ecef' /* Lighter grid lines */
                        },
                        ticks: {
                            color: '#343a40'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Product Name',
                            color: '#343a40'
                        },
                        grid: {
                            color: '#e9ecef'
                        },
                        ticks: {
                            color: '#343a40'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Current Inventory Levels',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        color: '#0056b3'
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Data for Near Expiries Chart
    const nearExpiriesData = {{ near_expiries | tojson }};

    if (nearExpiriesData && nearExpiriesData.length > 0) {
        const labels = nearExpiriesData.map(item => item.product_name);
        const data = nearExpiriesData.map(item => item.days_to_expiry);

        const ctx = document.getElementById('nearExpiriesChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Days to Expiry',
                    data: data,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)', /* Muted red */
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Days to Expiry',
                            color: '#343a40'
                        },
                        grid: {
                            color: '#e9ecef'
                        },
                        ticks: {
                            color: '#343a40'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Product Name',
                            color: '#343a40'
                        },
                        grid: {
                            color: '#e9ecef'
                        },
                        ticks: {
                            color: '#343a40'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Products Nearing Expiry',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        color: '#0056b3'
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
</script>
{% endblock %}
